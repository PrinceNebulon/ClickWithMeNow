<!DOCTYPE html>
<html>
<head>
	<style>
		body {
			background-color: #57DA8E;
			background-image: url('img/Circular Logo 4-color PNG.png');
			background-size: 100%;
			background-repeat: no-repeat;
		}
	</style>

	<title>CWMN Test</title>

	<script type="text/javascript" src="scripts/jquery-2.1.1.min.js"></script>
	<script type="text/javascript" src="scripts/jquery.cookie-1.4.1.min.js"></script>
	<script type="text/javascript" src="https://assets.clickwith.me/clickwithmenow-api.js"></script>
	<script type="text/javascript">
		$(document).ready(function() {
			// Try to get cookie
			var cookie = $.cookie('cwmntestdata');
			if (cookie != undefined){
				// Convert to JSON object
				var cookieData = eval('('+cookie+')');

				// Set fields
				$('#HostName').val(cookieData.HostName);
				$('#HostEmail').val(cookieData.HostEmail);
				$('#GuestName').val(cookieData.GuestName);
				$('#GuestEmail').val(cookieData.GuestEmail);
				$('#PhoneNumber').val(cookieData.PhoneNumber);
			}
		});

			

		CwmnAPI.on('init', function () { 
			var events = [
				'reinit',
				'init failed',
				'incompatible',
				'unauthorized',
				'ready no session',
				'ith init',
				'session pending',
				'in session',
				'session failed',
				'expired',
				'end session',
				'connection issue',
				'connection issue resolved',
				'guest connected',
				'guest disconnected',
				'roomdata update',
				'click',
				'waiting for replay',
				'replay progress',
				'replay complete',
				'replay error',
				'replay timeout warning',
				'replay timeout'
			];

			// Register for all events, for debugging purposes
			events.forEach(function(element, index, array){
				CwmnAPI.on(element, function () {
					$('#StateDisplay').text(element);
					console.debug('Event: ' + element);
				});
			});
		});

		function saveCookie(){
			var cookieData = '{ '+
				'"HostName":"' + $('#HostName').val() + '", ' +
				'"HostEmail":"' + $('#HostEmail').val() + '", ' +
				'"GuestName":"' + $('#GuestName').val() + '", ' +
				'"GuestEmail":"' + $('#GuestEmail').val() + '", ' +
				'"PhoneNumber":"' + $('#PhoneNumber').val() + '" ' +
				' }';
			$.cookie('cwmntestdata',cookieData);
		}

		function stripTrailingHash(str) {
		    if(str.substr(-1) == '#') {
		        return str.substr(0, str.length - 1);
		    }
		    return str;
		}

			
		// Called elsewhere to send an invite to host
		function sendInviteToHost() {
			saveCookie();
			CwmnAPI.session.inviteToHost({
				hostName: $('#HostName').val(),
				hostEmail: $('#HostEmail').val(),
				inviteName: $('#GuestName').val(),
				inviteEmail: $('#GuestEmail').val(),
				message: 'A new message',
				url: stripTrailingHash(window.location.href)
			}).then(function (result) {
				console.group('Invite sent to host');
				console.log(result);
				console.groupEnd();  
			}).catch(function (error) {
				console.log(error);
			});
		}

		function inviteToHostWithKey() {
			saveCookie();
			CwmnAPI.session.inviteToHost({
				hostName: $('#HostName').val(),
				hostEmail: $('#HostEmail').val(),
				ithJoinCode: 'tsmith',
				inviteName: $('#GuestName').val(),
				inviteEmail: $('#GuestEmail').val(),
				message: 'A new message',
				url: 'http://cwmn.mydevspace.com'
			}).then(function (result) {
				console.group('inviteToHostWithKey result');
				console.log(result);
				console.groupEnd();  
			}).catch(function (error) {
				console.log(error);
			});
		}

		// Called elsewhere to start hosting a session
		function startHosting() {
			saveCookie();
			CwmnAPI.session.start({
				hostName: $('#HostName').val(),
				hostEmail: $('#HostEmail').val(),
				isReplay: false
			}).then(function (result) {
				console.group('You are now hosting a session');
				console.log(result);
				console.groupEnd();  
			}).catch(function (error) {
				console.log(error);
			});
		}

		// Generate a private link for the current session
		function privateLink() {
			saveCookie();
			CwmnAPI.guest.getInviteLink().then(function(result) {
				console.group('Private Link');
				console.log(result);
				console.groupEnd();
				$('#PrivateLink').attr('href', result.inviteLink);
				$('#PrivateLink').text(result.inviteLink);
			}).catch(function(error) {
				console.log('error');
			});
		}

		function emailInvite() {
			saveCookie();
			CwmnAPI.guest.inviteGuest({
				guestName: $('#GuestName').val(),
				guestEmail: $('#GuestEmail').val(),
				message: 'Dude! Join my session!'
			}).then(function(result) {
				console.log(result);
			}).catch(function(error) {
				console.log(error);
			});
		}
		
		function smsInvite() {
			saveCookie();
			CwmnAPI.guest.inviteGuest({
				guestName: $('#GuestName').val(),
				guestPhone: $('#PhoneNumber').val(),
			}).then(function(result) {
				console.log(result);
			}).catch(function(error) {
				console.log(error);
			});
		}

		function endSession() {
			saveCookie();
			CwmnAPI.session.endSession();
		}




		// Called elsewhere to start recording a replay
		function startReplay() {
			saveCookie();
			CwmnAPI.session.start({
				hostName: $('#HostName').val(),
				hostEmail: $('#HostEmail').val(),
				isReplay: true
			}).then(function (result) {
				console.group('You are now recording a replay.');
				console.log(result);
				console.groupEnd();  
			}).catch(function (error) {
				console.log(error);
			});
		}

		function replayMuteAudio() {
			CwmnAPI.replay.muteAudio().then(function (result) {
				console.group('muteAudio callback');
				console.log(result);
				console.groupEnd();  
			}).catch(function (error) {
				console.error(error);
			});
		}

		function replaySendVideo() {
			CwmnAPI.replay.sendVideo({
				toEmails: $('#HostEmail').val(),
				subject: 'Replay video result',
				message: 'thanks for testing'
			}).then(function (result) {
				console.group('sendVideo callback');
				console.log(result);
				console.groupEnd();  
			}).catch(function (error) {
				console.error(error);
			});
		}

		function replayGetVideoUrl() {
			CwmnAPI.replay.getVideoURL().then(function (result) {
				console.group('getVideoURL callback');
				console.log(result);
				console.groupEnd();  
			}).catch(function (error) {
				console.error(error);
			});
		}

		function replayAbandonVideo() {
			CwmnAPI.replay.abandonVideo().then(function (result) {
				console.group('abandonVideo callback');
				console.log(result);
				console.groupEnd();  
			}).catch(function (error) {
				console.error(error);
			});
		}

		function replayGetRenderingProgress() {
			CwmnAPI.replay.getRenderingProgress().then(function (result) {
				console.group('getRenderingProgress callback');
				console.log(result);
				console.groupEnd();  
			}).catch(function (error) {
				console.error(error);
			});
		}

		function replayDismissError() {
			CwmnAPI.replay.dismissError().then(function (result) {
				console.group('dismissError callback');
				console.log(result);
				console.groupEnd();  
			}).catch(function (error) {
				console.error(error);
			});
		}
	</script>
</head>
<body>
	<span id="StateDisplay"></span><br/>
	Guest Name: <input type="text" id="GuestName" /><br />
	Guest Email: <input type="text" id="GuestEmail" /><br />
	Host Name: <input type="text" id="HostName" /><br />
	Host Email: <input type="text" id="HostEmail" /><br />
	Phone number (SMS): <input type="text" id="PhoneNumber" /><br />
	Private Link: <a id="PrivateLink"></a><br />
	<a href="#" onclick="sendInviteToHost()">sendInviteToHost()</a><br />
	<a href="#" onclick="inviteToHostWithKey()">inviteToHostWithKey()</a><br />
	<a href="#" onclick="startHosting()">startHosting()</a><br />
	<a href="#" onclick="privateLink()">privateLink()</a><br />
	<a href="#" onclick="emailInvite()">emailInvite()</a><br />
	<a href="#" onclick="smsInvite()">smsInvite()</a><br />
	<a href="#" onclick="endSession()">endSession()</a><br />
	<ul>
		<li><a href="#" onclick="startReplay()">startReplay()</a></li>
		<li><a href="#" onclick="replayMuteAudio()">replayMuteAudio()</a></li>
		<li><a href="#" onclick="replaySendVideo()">replaySendVideo()</a></li>
		<li><a href="#" onclick="replayGetVideoUrl()">replayGetVideoUrl()</a></li>
		<li><a href="#" onclick="replayAbandonVideo()">replayAbandonVideo()</a></li>
		<li><a href="#" onclick="replayGetRenderingProgress()">replayGetRenderingProgres()</a></li>
		<li><a href="#" onclick="replayDismissError()">replayDismissError()</a></li>
	</ul>
</body>
</html>